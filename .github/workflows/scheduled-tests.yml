name: Scheduled Full Test Suite

on:
  schedule:
    # Run at 2 AM UTC every day (11 AM KST)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - performance
          - contracts

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  POETRY_VERSION: '2.2.1'

jobs:
  # Unit & Security tests - member/month independent
  unit-and-security-tests:
    name: Unit & Security Tests (Parallel)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run unit & security tests (Parallel)
        run: |
          # Unit tests don't need member/month variations
          # Security tests are environment-independent
          poetry run pytest tests/unit/ tests/security/ \
            -n auto \
            --dist=loadfile \
            --maxfail=10 \
            --cov=libs \
            --cov-report=xml:coverage-unit-security.xml \
            --junit-xml=test-results-unit-security.xml \
            -v
        env:
          PYTEST_XDIST_AUTO_NUM_WORKERS: 4

      - name: Upload test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: test-results-unit-security
          path: |
            test-results-unit-security.xml
            coverage-unit-security.xml
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7  # v5.5.1
        with:
          files: ./coverage-unit-security.xml
          flags: scheduled,unit,security
          name: unit-and-security-tests
          fail_ci_if_error: false

  # Integration tests with matrix - member/month dependent
  integration-test-suite:
    name: Integration - ${{ matrix.member }} (${{ matrix.month }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        member: [kr, jp, etc]
        month: ['current', 'previous']

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set test month
        id: set-month
        run: |
          if [[ "${{ matrix.month }}" = "current" ]]; then
            echo "MONTH=$(date +%Y-%m)" >> $GITHUB_OUTPUT
          else
            echo "MONTH=$(date -d "1 month ago" +%Y-%m)" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run integration & contract tests (Parallel)
        run: |
          # Integration and contract tests need member/month context
          # Run in parallel for speed (3-4x faster)
          poetry run pytest tests/integration/ tests/contracts/ \
            --env alpha \
            --member ${{ matrix.member }} \
            --month ${{ steps.set-month.outputs.MONTH }} \
            --cov=libs \
            --cov-report=xml:coverage-${{ matrix.member }}-${{ matrix.month }}.xml \
            --junit-xml=test-results-${{ matrix.member }}-${{ matrix.month }}.xml \
            -n auto \
            --dist=loadfile \
            --maxfail=5 \
            -v
        continue-on-error: true
        env:
          PYTEST_XDIST_AUTO_NUM_WORKERS: 4

      - name: Upload test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: test-results-${{ matrix.member }}-${{ matrix.month }}
          path: test-results-*.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7  # v5.5.1
        with:
          files: ./coverage-${{ matrix.member }}-${{ matrix.month }}.xml
          flags: scheduled,integration,${{ matrix.member }},${{ matrix.month }}
          name: integration-${{ matrix.member }}-${{ matrix.month }}
          fail_ci_if_error: false

  # Performance benchmark tests
  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Start Mock Server
        run: |
          python -m mock_server.run_server &
          MOCK_PID=$!
          echo "Mock server started with PID: $MOCK_PID"

          # Wait for server to be ready
          for i in {1..30}; do
            if curl -s --max-time 2 http://localhost:5000/health > /dev/null 2>&1; then
              echo "âœ“ Mock server is ready"
              break
            fi
            if [[ $i -eq 30 ]]; then
              echo "âœ— Mock server failed to start"
              exit 1
            fi
            echo "Waiting for mock server... ($i/30)"
            sleep 1
          done
        env:
          FLASK_ENV: production
          MOCK_SERVER_RATE_LIMIT: 500

      - name: Run performance tests (Sequential - Locust requires it)
        run: |
          # Performance/locust tests MUST run sequentially (no -n flag)
          # Locust uses gevent which conflicts with pytest-xdist
          poetry run pytest tests/performance/ -v \
            --timeout=300 \
            --benchmark-only \
            --benchmark-json=performance-results.json \
            --benchmark-autosave \
            --junit-xml=performance-test-results.xml
        continue-on-error: true
        env:
          USE_MOCK_SERVER: 'true'
          MOCK_SERVER_URL: http://localhost:5000
          MOCK_SERVER_PORT: '5000'

      - name: Upload performance results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: performance-results
          path: |
            performance-results.json
            .benchmarks/

  # Security scan with detailed report
  security-scan:
    name: Security Scan (Full)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a  # v1.4.1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run comprehensive security scan
        run: |
          # Bandit scan
          poetry run bandit -r libs/ tests/ -f json -o bandit_report.json -ll || true

          # Safety check
          poetry run safety check --json > safety_report.json || true

          # Check for secrets
          poetry run detect-secrets scan --all-files > secrets_report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        if: always()
        with:
          name: security-reports-full
          path: |
            bandit_report.json
            safety_report.json
            secrets_report.json

  # Test report summary
  test-summary:
    name: Generate Test Summary
    runs-on: ubuntu-latest
    needs: [unit-and-security-tests, integration-test-suite, performance-tests, security-scan]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0

      - name: Generate summary report
        run: |
          echo "# Daily Test Report - $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "- Unit & Security Tests: ${{ needs.unit-and-security-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Test Suite: ${{ needs.integration-test-suite.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Optimization Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Parallel execution enabled (-n auto)" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Unit tests run once (no matrix duplication)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Integration tests with member/month matrix" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Expected time: ~23min (vs ~90min sequential)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse test results if available
          if [[ -f "test-results-kr-current/test-results-kr-current.xml" ]]; then
            echo "## Test Metrics" >> $GITHUB_STEP_SUMMARY
            echo "Processing test results..." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Scheduled tests failed! Check the results above." >> $GITHUB_STEP_SUMMARY
