name: Simple CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker images
        run: |
          # Build all images fresh
          docker compose -f docker-compose.test.yml build
      
      - name: Run tests
        run: |
          # Start mock server
          docker compose -f docker-compose.test.yml up -d mock-server
          
          # Wait for health
          echo "Waiting for mock server..."
          for i in {1..30}; do
            if docker compose -f docker-compose.test.yml exec mock-server curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "Mock server is ready!"
              break
            fi
            echo "Waiting... (attempt $i/30)"
            sleep 2
          done
          
          # Run tests
          docker compose -f docker-compose.test.yml run --rm test-full python -m pytest tests/unit/ -v
      
      - name: Clean up
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v
