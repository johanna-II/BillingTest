name: Test Report

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  report:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'skipped'

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download test results artifacts
        uses: dawidd6/action-download-artifact@ac66b43f0e6a346234dd65d4d0c8fbb31cb316e5  # v11
        with:
          workflow: ${{ github.event.workflow_run.workflow_id }}
          run_id: ${{ github.event.workflow_run.id }}
          name: test-results-*
          name_is_regexp: true
          path: test-results

      - name: List downloaded files
        run: |
          echo "üìÅ Downloaded files in test-results/:"
          ls -laR test-results/ 2>/dev/null || echo "‚ö†Ô∏è test-results directory not found"
          echo ""
          echo "üìÅ All XML files:"
          find test-results -name "*.xml" -type f 2>/dev/null || echo "No XML files found"

      - name: Publish Test Report
        uses: dorny/test-reporter@7b7927aa7da8b82e81e755810cb51f39941a2cc7  # v2.2.0
        if: success() || failure()
        with:
          name: Test Results
          path: 'test-results/**/test-results-*.xml'
          reporter: java-junit
          fail-on-error: false

      - name: Generate Summary
        id: summary
        run: |
          # Parse JUnit XML files and generate summary
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import glob
          import json

          results = {
              "unit": {"total": 0, "passed": 0, "failed": 0, "skipped": 0, "time": 0},
              "integration": {"total": 0, "passed": 0, "failed": 0, "skipped": 0, "time": 0},
              "contracts": {"total": 0, "passed": 0, "failed": 0, "skipped": 0, "time": 0},
              "comprehensive": {"total": 0, "passed": 0, "failed": 0, "skipped": 0, "time": 0},
          }

          for xml_file in glob.glob("test-results/**/test-results-*.xml", recursive=True):
              try:
                  tree = ET.parse(xml_file)
                  root = tree.getroot()

                  # Determine test type from filename
                  test_type = "unit"
                  if "integration" in xml_file:
                      test_type = "integration"
                  elif "contract" in xml_file:
                      test_type = "contracts"
                  elif "comprehensive" in xml_file:
                      test_type = "comprehensive"

                  # Parse testsuite
                  for testsuite in root.findall('.//testsuite'):
                      tests = int(testsuite.get('tests', 0))
                      failures = int(testsuite.get('failures', 0))
                      errors = int(testsuite.get('errors', 0))
                      skipped = int(testsuite.get('skipped', 0))
                      time = float(testsuite.get('time', 0))

                      results[test_type]["total"] += tests
                      results[test_type]["failed"] += failures + errors
                      results[test_type]["skipped"] += skipped
                      results[test_type]["passed"] += tests - failures - errors - skipped
                      results[test_type]["time"] += time
              except Exception as e:
                  print(f"Error parsing {xml_file}: {e}")

          # Output as JSON
          print(json.dumps(results, indent=2))

          # Save to file
          with open('test_summary.json', 'w') as f:
              json.dump(results, f, indent=2)
          EOF

      - name: Comment PR
        if: github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const fs = require('fs');

            let results;
            try {
              results = JSON.parse(fs.readFileSync('test_summary.json', 'utf8'));
            } catch (e) {
              console.log('No test summary found');
              return;
            }

            // Calculate totals
            let totalTests = 0;
            let totalPassed = 0;
            let totalFailed = 0;
            let totalTime = 0;

            for (const [type, data] of Object.entries(results)) {
              totalTests += data.total;
              totalPassed += data.passed;
              totalFailed += data.failed;
              totalTime += data.time;
            }

            // Calculate pass rate
            const passRate = totalTests > 0 ? ((totalPassed / totalTests) * 100).toFixed(1) : 0;

            // Determine emoji
            const emoji = totalFailed === 0 ? '‚úÖ' : '‚ö†Ô∏è';

            // Build comment
            const comment = `
            ## ${emoji} Test Results

            **Overall:** ${totalPassed}/${totalTests} tests passed (${passRate}%)
            **Duration:** ${totalTime.toFixed(1)}s

            ### Test Breakdown

            | Test Type | Total | Passed | Failed | Skipped | Duration |
            |-----------|-------|--------|--------|---------|----------|
            | **Unit** | ${results.unit.total} | ${results.unit.passed} | ${results.unit.failed} | ${results.unit.skipped} | ${results.unit.time.toFixed(1)}s |
            | **Integration** | ${results.integration.total} | ${results.integration.passed} | ${results.integration.failed} | ${results.integration.skipped} | ${results.integration.time.toFixed(1)}s |
            | **Contracts** | ${results.contracts.total} | ${results.contracts.passed} | ${results.contracts.failed} | ${results.contracts.skipped} | ${results.contracts.time.toFixed(1)}s |
            | **Comprehensive** | ${results.comprehensive.total} | ${results.comprehensive.passed} | ${results.comprehensive.failed} | ${results.comprehensive.skipped} | ${results.comprehensive.time.toFixed(1)}s |

            ${totalFailed > 0 ? '‚ö†Ô∏è **Some tests failed.** Please review the workflow logs.' : '‚úÖ **All tests passed!**'}

            <details>
            <summary>üìä Test Execution Metrics</summary>

            - **Fastest Suite:** ${Object.entries(results).sort((a, b) => a[1].time - b[1].time)[0][0]}
            - **Total Test Count:** ${totalTests}
            - **Pass Rate:** ${passRate}%

            </details>
            `;

            // Find PR number
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            const pr = pulls.data.find(p =>
              p.head.sha === context.payload.workflow_run.head_sha
            );

            if (pr) {
              // Find existing comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });

              const botComment = comments.data.find(c =>
                c.user.type === 'Bot' && c.body.includes('Test Results')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment,
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment,
                });
              }
            }

      - name: Add to Job Summary
        run: |
          python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json

          with open('test_summary.json') as f:
              results = json.load(f)

          print("# üìä Test Execution Summary\n")

          for test_type, data in results.items():
            if data["total"] > 0:
              pass_rate = (data["passed"] / data["total"]) * 100
              emoji = "‚úÖ" if data["failed"] == 0 else "‚ö†Ô∏è"

              print(f"## {emoji} {test_type.capitalize()} Tests\n")
              print(f"- **Total:** {data['total']}")
              print(f"- **Passed:** {data['passed']}")
              print(f"- **Failed:** {data['failed']}")
              print(f"- **Skipped:** {data['skipped']}")
              print(f"- **Duration:** {data['time']:.2f}s")
              print(f"- **Pass Rate:** {pass_rate:.1f}%\n")
          EOF
